name: Backfill Historical Episodes

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: "Episodes per batch (default 10)"
        required: false
        default: "10"
      dry_run:
        description: "Dry run (preview only)"
        required: false
        default: "false"
        type: boolean
      auto_continue:
        description: "Auto-trigger next batch when done"
        required: false
        default: "true"
        type: boolean

env:
  MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
  MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
  HF_TOKEN: ${{ secrets.HF_TOKEN }}

jobs:
  backfill:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -e . modal huggingface_hub

      - name: Run backfill
        id: backfill
        run: |
          ARGS="--batch-size ${{ inputs.batch_size || '10' }}"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          python scripts/backfill.py $ARGS --output-dir data/transcripts 2>&1 | tee /tmp/backfill.log

          # Parse remaining count from log
          REMAINING=$(grep "Remaining:" /tmp/backfill.log | tail -1 | grep -oP '\d+(?= episodes)' || echo "0")
          echo "remaining=$REMAINING" >> "$GITHUB_OUTPUT"

          # Check if all done
          if grep -q "All episodes already transcribed" /tmp/backfill.log; then
            echo "remaining=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for new transcripts
        if: inputs.dry_run != 'true'
        id: check
        run: |
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard data/)" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No new transcripts"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            count=$(git diff --name-only data/ | wc -l)
            new=$(git ls-files --others --exclude-standard data/ | wc -l)
            echo "total=$((count + new))" >> "$GITHUB_OUTPUT"
          fi

      - name: Merge transcripts to main
        if: inputs.dry_run != 'true' && steps.check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "podcast-pipeline[bot]"
          git config user.email "bot@podcast-pipeline.local"
          git add data/
          git commit -m "backfill: ${{ steps.check.outputs.total }} transcripts [auto]"
          git push origin main

      - name: Trigger next batch
        if: >-
          inputs.dry_run != 'true'
          && inputs.auto_continue != 'false'
          && steps.backfill.outputs.remaining != '0'
          && steps.check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”„ ${{ steps.backfill.outputs.remaining }} episodes remaining, triggering next batch..."
          gh workflow run backfill.yml \
            --field batch_size=${{ inputs.batch_size || '10' }} \
            --field auto_continue=true
