name: Backfill Historical Episodes

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: "Episodes per batch (default 10)"
        required: false
        default: "10"
      dry_run:
        description: "Dry run (preview only)"
        required: false
        default: "false"
        type: boolean
      audio_only:
        description: "Only upload audio for existing transcripts"
        required: false
        default: "false"
        type: boolean

env:
  MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
  MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
  HF_TOKEN: ${{ secrets.HF_TOKEN }}

jobs:
  backfill:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -e . modal huggingface_hub

      - name: Upload audio only (for existing transcripts)
        if: inputs.audio_only == 'true'
        run: |
          python scripts/upload_audio_batch.py --batch-size ${{ inputs.batch_size || '10' }}

      - name: Run backfill
        if: inputs.audio_only != 'true'
        id: backfill
        run: |
          ARGS="--batch-size ${{ inputs.batch_size || '10' }}"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          python scripts/backfill.py $ARGS --output-dir data/transcripts

      - name: Check for new transcripts
        if: inputs.dry_run != 'true'
        id: check
        run: |
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard data/)" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No new transcripts"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            count=$(git diff --name-only data/ | wc -l)
            new=$(git ls-files --others --exclude-standard data/ | wc -l)
            echo "total=$((count + new))" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR with backfill transcripts
        if: inputs.dry_run != 'true' && steps.check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          BRANCH="backfill/${DATE}-$(date +%s)"

          git config user.name "podcast-pipeline[bot]"
          git config user.email "bot@podcast-pipeline.local"

          git checkout -b "$BRANCH"
          git add data/
          git commit -m "feat: backfill ${{ steps.check.outputs.total }} transcripts (${DATE})"
          git push origin "$BRANCH"

          gh pr create \
            --title "ðŸ“š Backfill transcripts â€” ${DATE}" \
            --body "## Backfill Transcripts

          Batch backfill of historical episodes.

          **Files added**: ${{ steps.check.outputs.total }}
          **Batch size**: ${{ inputs.batch_size || '10' }}

          ---
          _Auto-generated by [backfill](.github/workflows/backfill.yml)_" \
            --base main \
            --head "$BRANCH"
