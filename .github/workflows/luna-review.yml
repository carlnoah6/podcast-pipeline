name: Luna Auto-Review

on:
  # Run every 15 minutes
  schedule:
    - cron: "*/15 * * * *"
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auto-merge CodeRabbit-approved PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "Checking for mergeable PRs..."

          # List open PRs targeting main
          prs=$(gh pr list --base main --state open --json number,title,reviewDecision,mergeable,statusCheckRollup --jq '.[]')

          if [ -z "$prs" ]; then
            echo "No open PRs found."
            exit 0
          fi

          echo "$prs" | jq -c '.' | while read -r pr; do
            number=$(echo "$pr" | jq -r '.number')
            title=$(echo "$pr" | jq -r '.title')
            decision=$(echo "$pr" | jq -r '.reviewDecision')
            mergeable=$(echo "$pr" | jq -r '.mergeable')

            echo ""
            echo "PR #${number}: ${title}"
            echo "  Review decision: ${decision}"
            echo "  Mergeable: ${mergeable}"

            # Check all status checks passed
            checks_ok=true
            echo "$pr" | jq -c '.statusCheckRollup[]?' | while read -r check; do
              state=$(echo "$check" | jq -r '.status // .state // "unknown"')
              conclusion=$(echo "$check" | jq -r '.conclusion // "pending"')
              name=$(echo "$check" | jq -r '.name // .context // "unknown"')

              if [ "$conclusion" != "SUCCESS" ] && [ "$conclusion" != "success" ] && [ "$state" != "SUCCESS" ] && [ "$state" != "success" ]; then
                echo "  Check '${name}' not passed: state=${state}, conclusion=${conclusion}"
                checks_ok=false
              fi
            done

            # Only merge if: approved + mergeable + checks pass
            if [ "$decision" = "APPROVED" ] && [ "$mergeable" = "MERGEABLE" ] && [ "$checks_ok" = "true" ]; then
              echo "  -> Merging PR #${number}..."
              gh pr merge "$number" --squash --auto \
                --subject "merge: ${title} (#${number})" \
                --body "Auto-merged by Luna. CodeRabbit approved, all checks passed."
              echo "  -> Done."
            else
              echo "  -> Skipping (not ready to merge)."
            fi
          done
