name: Check New Episodes

on:
  schedule:
    - cron: "0 2 * * *"  # 10:00 SGT daily
  workflow_dispatch:
    inputs:
      podcast_id:
        description: "Override podcast ID (leave empty for default)"
        required: false
      max_episodes:
        description: "Max episodes to process (0 = all new)"
        required: false
        default: "5"

env:
  MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
  MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

jobs:
  check-and-transcribe:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -e . modal

      - name: Run pipeline
        id: pipeline
        run: |
          python scripts/run_pipeline.py \
            --podcast-id "${{ inputs.podcast_id || '' }}" \
            --max-episodes "${{ inputs.max_episodes || '5' }}" \
            --output-dir data/transcripts

      - name: Check for new transcripts
        id: check
        run: |
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard data/)" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No new transcripts"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            count=$(git diff --name-only data/ | wc -l)
            new=$(git ls-files --others --exclude-standard data/ | wc -l)
            echo "total=$((count + new))" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR with new transcripts
        if: steps.check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          BRANCH="transcripts/${DATE}"

          git config user.name "podcast-pipeline[bot]"
          git config user.email "bot@podcast-pipeline.local"

          git checkout -b "$BRANCH"
          git add data/
          git commit -m "feat: add ${{ steps.check.outputs.total }} transcripts (${DATE})"
          git push origin "$BRANCH"

          gh pr create \
            --title "üìù New transcripts ‚Äî ${DATE}" \
            --body "$(cat <<'EOF'
          ## New Transcripts

          Automated transcription run on ${DATE}.

          **Files changed**: ${{ steps.check.outputs.total }}

          ### Pipeline
          - RSS fetch ‚Üí episode filter ‚Üí Modal Whisper (large-v3) ‚Üí format

          ---
          _Auto-generated by [check-new-episodes](.github/workflows/check-new-episodes.yml)_
          EOF
          )" \
            --base main \
            --head "$BRANCH"
